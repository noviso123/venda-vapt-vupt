{% extends "base.html" %}

{% block content %}
<!-- BUSCA E CABEÇALHO -->
<div class="mb-12 text-center">
    <!-- FOTO DE PERFIL DO VENDEDOR -->
    {% if store.logo_url %}
    <div class="w-24 h-24 mx-auto mb-4 rounded-full border-4 border-white shadow-xl overflow-hidden">
        <img src="{{ store.logo_url }}" alt="Vendedor" class="w-full h-full object-cover">
    </div>
    {% else %}
    <div
        class="w-24 h-24 mx-auto mb-4 rounded-full bg-white flex items-center justify-center border-4 border-white shadow-xl overflow-hidden p-1">
        <img src="/static/logo.png" alt="Logo" class="w-full h-full object-contain">
    </div>
    {% endif %}

    <h2 class="text-3xl font-black text-slate-800 mb-2">{{ store.name }}</h2>
    <p class="text-slate-500 mb-8">Produtos de alta qualidade com entrega rápida.</p>

    <form action="/" method="GET" class="max-w-xl mx-auto flex gap-2">
        <input type="text" name="q" placeholder="Buscar produtos..." value="{{ query }}"
            class="flex-1 px-6 py-4 rounded-2xl glass border border-slate-200 focus:border-primary outline-none transition-all">
        <button type="submit"
            class="bg-primary text-white px-8 rounded-2xl font-bold hover:bg-opacity-90 transition-all">
            Buscar
        </button>
    </form>
</div>

<!-- GRADE DE PRODUTOS -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
    {% for product in products %}
    <div
        class="glass p-6 rounded-3xl group transition-all hover:shadow-2xl hover:shadow-primary/5 hover:-translate-y-2">
        <div class="aspect-square rounded-2xl overflow-hidden mb-6 bg-slate-100 relative shadow-inner">
            <div class="relative w-full h-full group/slider">
                {% if product.image_url %}
                <img src="{{ product.image_url }}" alt="{{ product.name }}" id="img-{{ product.id }}"
                    class="w-full h-full object-cover group-hover:scale-110 transition-all duration-500"
                    data-main="{{ product.image_url }}"
                    data-images="{{ ([product.image_url] + (product.product_images|map(attribute='image_url')|list))|join(',') }}">

                {% if product.product_images %}
                <div
                    class="absolute bottom-2 left-0 right-0 flex justify-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                    <span class="w-1.5 h-1.5 rounded-full bg-white shadow"></span>
                    {% for img in product.product_images %}
                    <span class="w-1.5 h-1.5 rounded-full bg-white/50 shadow"></span>
                    {% endfor %}
                </div>
                {% endif %}

                {% else %}
                <div class="w-full h-full flex items-center justify-center text-slate-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                </div>
                {% endif %}
            </div>

            <!-- TAGS DE STATUS -->
            <div class="absolute top-4 right-4 flex flex-col gap-2 items-end">
                {% if product.external_url %}
                <span
                    class="bg-emerald-500 text-white text-[9px] font-black px-3 py-1 rounded-full uppercase shadow-lg">Oferta
                    Externa</span>
                {% endif %}

                {% if product.stock_quantity <= 0 %}
                <span
                    class="bg-red-500 text-white text-[10px] font-black px-3 py-1 rounded-full uppercase shadow-lg">Esgotado</span>
                {% elif product.stock_quantity < 5 %}
                <span
                    class="bg-orange-500 text-white text-[10px] font-black px-3 py-1 rounded-full uppercase shadow-lg">Só
                    {{ product.stock_quantity }} restam</span>
                {% endif %}
            </div>
        </div>

        <h3 class="text-xl font-bold text-slate-800 mb-2 truncate" title="{{ product.get('name', '') }}">
            {{ product.get('name', 'Produto') }}
        </h3>
        <p class="text-sm text-slate-500 mb-6 line-clamp-2 h-10">{{ product.get('description', '') }}</p>

        <div class="space-y-4">
            <div class="flex items-center justify-between">
                <span class="text-2xl font-black text-primary">R$ {{ "%.2f"|format(product.price or 0) }}</span>

                {% set p_id = product.id if product.id else loop.index0 %}
                {% set stock = product.get('stock_quantity', 0) %}
                {% if not product.get('external_url') and stock > 0 %}
                <!-- Seletor de Qtd (Mobile Friendly) -->
                <div class="flex items-center bg-slate-100 rounded-xl p-1 gap-3">
                    <button onclick="changeQty('{{ p_id }}', -1)"
                        class="w-8 h-8 flex items-center justify-center text-slate-500 font-bold hover:bg-white rounded-lg transition-all">-</button>
                    <span id="qty-{{ p_id }}" class="text-sm font-black text-slate-800 w-4 text-center">1</span>
                    <button onclick="changeQty('{{ p_id }}', 1)"
                        class="w-8 h-8 flex items-center justify-center text-slate-500 font-bold hover:bg-white rounded-lg transition-all">+</button>
                </div>
                {% endif %}
            </div>

            {% if product.get('external_url') %}
            <a href="/clique/{{ p_id }}" target="_blank"
                class="w-full py-4 bg-slate-800 text-white rounded-2xl font-black text-center block shadow-xl hover:bg-slate-900 transition-all active:scale-95 uppercase tracking-wider text-sm">
                COMPRAR AGORA NO SITE
            </a>
            {% elif stock > 0 %}
            <button id="btn-{{ p_id }}" hx-post="/carrinho/adicionar"
                hx-vals='js:{"product_id": "{{ p_id }}", "quantity": document.getElementById("qty-{{ p_id }}") ? document.getElementById("qty-{{ p_id }}").innerText : 1}'
                hx-target="#cart-indicator"
                class="w-full py-4 btn-primary text-white rounded-2xl font-black shadow-xl shadow-blue-100 hover:scale-[1.02] active:scale-95 transition-all uppercase tracking-wider text-sm flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
                ADICIONAR AO CARRINHO
            </button>
            {% else %}
            <button disabled
                class="w-full py-4 bg-slate-200 text-slate-400 rounded-2xl font-black cursor-not-allowed uppercase text-sm">
                PRODUTO INDISPONÍVEL
            </button>
            {% endif %}
        </div>
    </div>
    {% else %}
    <div class="col-span-full py-24 text-center">
        <div class="w-20 h-20 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-6">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-slate-300" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
        </div>
        <p class="text-slate-400 text-lg font-bold">Nenhum produto encontrado.</p>
        {% if query %}
        <a href="/" class="text-primary font-bold hover:underline mt-2 inline-block">Limpar filtros de busca</a>
        {% endif %}
    </div>
    {% endfor %}
</div>

<!-- Lógica Auxiliar -->
<script>
    function changeQty ( id, delta )
    {
        const qtyEl = document.getElementById( 'qty-' + id );
        let current = parseInt( qtyEl.innerText );
        current += delta;
        if ( current < 1 ) current = 1;
        if ( current > 99 ) current = 99;
        qtyEl.innerText = current;
    }

    document.body.addEventListener( 'htmx:afterRequest', function ( evt )
    {
        if ( evt.detail.xhr.status === 200 )
        {
            try
            {
                const res = JSON.parse( evt.detail.xhr.responseText );
                if ( res.status === 'success' )
                {
                    const indicator = document.getElementById( 'cart-indicator' );
                    indicator.classList.add( 'scale-125', 'bg-red-500' );
                    setTimeout( () => indicator.classList.remove( 'scale-125', 'bg-red-500' ), 500 );
                } else if ( res.status === 'error' )
                {
                    alert( res.message );
                }
            } catch ( e ) { }
        }
    } );

    // Script de Carrossel Simples
    document.querySelectorAll( '[data-images]' ).forEach( img =>
    {
        const images = img.dataset.images.split( ',' );
        if ( images.length <= 1 ) return;

        let idx = 0;
        let interval;

        const parent = img.closest( '.group' );
        parent.addEventListener( 'mouseenter', () =>
        {
            interval = setInterval( () =>
            {
                idx = ( idx + 1 ) % images.length;
                img.src = images[ idx ];
            }, 1500 );
        } );

        parent.addEventListener( 'mouseleave', () =>
        {
            clearInterval( interval );
            img.src = img.dataset.main;
            idx = 0;
        } );
    } );
</script>
{% endblock %}

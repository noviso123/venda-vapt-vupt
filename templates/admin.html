{% extends "base.html" %}

{% block content %}
<div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-2">
    <div class="flex items-center gap-4">
        <h1 class="text-4xl font-black text-slate-800">Painel de Controle</h1>
        <a href="/logout"
            class="text-xs font-bold text-red-400 hover:text-red-600 transition-all uppercase tracking-widest">Sair</a>
    </div>
    <a href="/vendedor/clientes"
        class="px-6 py-3 bg-sky-500/10 text-primary rounded-2xl font-black text-sm flex items-center gap-2 hover:bg-sky-500/20 transition-all">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path
                d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a7 7 0 00-7 7v1h11v-1a7 7 0 00-7-7z" />
        </svg>
        GERIR CLIENTES
    </a>
</div>
<p class="text-slate-500">Gestão da loja: <span
        class="font-bold text-primary">{{ store.name if store else 'Configuração Pendente' }}</span></p>

<!-- ABAS -->
<div class="flex gap-8 border-b border-slate-200 mb-8 mt-8 overflow-x-auto whitespace-nowrap">
    <button onclick="switchTab('orders')" id="tab-orders"
        class="pb-4 px-2 font-bold text-primary border-b-2 border-primary transition-all">Pedidos</button>
    <button onclick="switchTab('products')" id="tab-products"
        class="pb-4 px-2 font-bold text-slate-400 border-b-2 border-transparent transition-all">Produtos &
        Estoque</button>
    <button onclick="switchTab('settings')" id="tab-settings"
        class="pb-4 px-2 font-bold text-slate-400 border-b-2 border-transparent transition-all">Configurações
        Pix/Branding</button>
</div>

<!-- SEÇÃO DE PEDIDOS -->
<div id="section-orders" class="space-y-4">
    {% for order in orders %}
    <div class="glass p-6 rounded-3xl flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
            <div class="flex items-center gap-2 mb-1">
                <span class="text-xs font-black uppercase text-slate-400">#{{ order.id[:8] }}</span>
                <span
                    class="bg-blue-100 text-blue-600 text-[10px] font-black px-2 py-0.5 rounded-full uppercase">{{ order.status }}</span>
            </div>
            <h3 class="font-bold text-slate-800">{{ order.customers.name }}</h3>
            <p class="text-xs text-slate-500">{{ order.delivery_address }}</p>
        </div>
        <div class="text-right flex flex-col items-end">
            <p class="text-xl font-black text-primary mb-2">R$ {{ "%.2f"|format(order.total) }}</p>
            <form action="/vendedor/pedido/{{ order.id }}/status" method="POST" class="flex gap-2">
                <select name="status" class="text-xs border border-slate-200 rounded-lg px-2 py-1 outline-none">
                    <option value="pending_payment" {% if order.status == 'pending_payment' %}selected{% endif %}>
                        Pendente</option>
                    <option value="paid" {% if order.status == 'paid' %}selected{% endif %}>Pago</option>
                    <option value="shipped" {% if order.status == 'shipped' %}selected{% endif %}>Enviado</option>
                    <option value="delivered" {% if order.status == 'delivered' %}selected{% endif %}>Entregue</option>
                </select>
                <button type="submit" class="btn btn-secondary btn-sm">OK</button>
            </form>
        </div>
    </div>
    {% else %}
    <div class="py-20 text-center text-slate-400">Nenhum pedido recebido ainda.</div>
    {% endfor %}
</div>

<!-- SEÇÃO DE PRODUTOS -->
<div id="section-products" class="hidden space-y-8">
    <div class="glass p-8 rounded-3xl border border-primary/10">
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
            <h3 class="text-xl font-bold">Adicionar Novo Produto</h3>
            <div class="flex flex-1 max-w-md gap-2">
                <input type="text" id="import_url" placeholder="Importar via Link (Ex: Outro site)"
                    class="flex-1 px-4 py-2 text-sm rounded-xl border border-slate-200 outline-none focus:border-primary">
                <button onclick="importProduct()" class="btn btn-secondary">IMPORTAR</button>
            </div>
        </div>

        <form id="productForm" action="/vendedor/produto/novo" method="POST" enctype="multipart/form-data"
            class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-bold mb-2">Nome do Produto</label>
                    <input type="text" name="name" id="p_name" required
                        class="w-full px-4 py-3 rounded-xl border border-slate-200">
                </div>
                <div>
                    <label class="block text-sm font-bold mb-2">Descrição</label>
                    <textarea name="description" id="p_desc"
                        class="w-full px-4 py-3 rounded-xl border border-slate-200 h-32"></textarea>
                </div>
            </div>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold mb-2">Preço (R$)</label>
                        <input type="number" step="0.01" name="price" id="p_price" placeholder="0.00"
                            class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:border-primary outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2">Estoque</label>
                        <input type="number" name="stock_quantity" id="p_stock" value="1"
                            class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:border-primary outline-none">
                    </div>
                </div>
                <div>
                    <input type="hidden" name="extra_images" id="p_extra_images">
                    <label class="block text-sm font-bold mb-2 text-sky-600">Link Externo (Opcional -
                        Afiliado/Dropshipping)</label>
                    <input type="text" name="external_url" id="p_ext" placeholder="https://..."
                        class="w-full px-4 py-3 rounded-xl border border-sky-200 bg-sky-50/10 placeholder:text-sky-300">
                    <p class="text-[10px] text-slate-400 mt-1">Se preenchido, o botão no site direcionará o cliente para
                        este link.</p>
                </div>
                <div>
                    <label class="block text-sm font-bold mb-2">Foto / Imagem</label>

                    <!-- Preview da Imagem Importada -->
                    <div id="img_preview_container" class="hidden mb-3">
                        <div class="flex items-start gap-3">
                            <img id="img_preview" src="" alt="Preview"
                                class="w-24 h-24 object-cover rounded-xl border-2 border-sky-500 shadow-lg">
                            <div class="flex-1">
                                <p class="text-xs text-sky-600 font-bold mb-1">✓ Imagem Importada</p>
                                <input type="text" name="image_url" id="p_img" placeholder="URL da imagem"
                                    class="w-full px-3 py-2 rounded-lg border border-sky-200 text-xs bg-sky-50">
                            </div>
                        </div>
                    </div>

                    <!-- Galeria de Imagens Extras Importadas -->
                    <div id="extra_imgs_preview" class="hidden mb-3">
                        <p class="text-xs text-slate-500 font-bold mb-2">Galeria Importada:</p>
                        <div id="extra_imgs_grid" class="flex flex-wrap gap-2"></div>
                    </div>

                    <!-- Upload Manual -->
                    <div class="file-upload" id="file-upload-zone">
                        <svg class="file-upload-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        <span class="file-upload-text" id="file-upload-text">Clique para enviar imagem</span>
                        <span class="file-upload-hint">ou arraste o arquivo aqui</span>
                        <input type="file" name="file" accept="image/*" onchange="updateFileLabel(this)">
                    </div>
                    <input type="hidden" name="extra_images" id="p_extra_images">
                </div>
                <button type="submit" class="btn btn-primary btn-lg btn-block">
                    PUBLICAR PRODUTO NO VAPT VUPT
                </button>
            </div>
        </form>
    </div>

    <!-- LISTA DE PRODUTOS E ESTOQUE -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for product in products %}
        <div class="glass p-5 rounded-3xl flex flex-col gap-4 relative group hover:border-primary/30 transition-all">
            <div class="flex items-center gap-4">
                <div class="space-y-2">
                    <!-- Imagem Principal -->
                    <div
                        class="w-20 h-20 rounded-2xl bg-slate-100 overflow-hidden shrink-0 shadow-sm relative group/img">
                        {% if product.image_url %}
                        <img src="{{ product.image_url }}" class="w-full h-full object-cover">
                        {% endif %}
                    </div>
                    <!-- Galeria Extra -->
                    <div class="flex flex-wrap gap-1 max-w-[200px]">
                        {% for img in product.product_images %}
                        <div class="w-8 h-8 rounded bg-slate-100 relative group/mini">
                            <img src="{{ img.image_url }}" class="w-full h-full object-cover rounded">
                            <form action="/vendedor/produto/imagem/{{ img.id }}/delete" method="POST"
                                class="absolute inset-0 bg-black/50 hidden group-hover/mini:flex items-center justify-center rounded cursor-pointer"
                                onclick="this.submit()">
                                <span class="text-white text-[10px]">✕</span>
                            </form>
                        </div>
                        {% endfor %}

                        <!-- Botão Add Imagem -->
                        <form action="/vendedor/produto/{{ product.id }}/imagem/nova" method="POST"
                            enctype="multipart/form-data" class="w-8 h-8">
                            <label
                                class="w-full h-full bg-slate-100 rounded border border-dashed border-slate-300 flex items-center justify-center cursor-pointer hover:bg-slate-200">
                                <span class="text-slate-400 text-xs">+</span>
                                <input type="file" name="file" class="hidden" onchange="this.form.submit()">
                            </label>
                        </form>
                    </div>
                </div>
                <div class="flex-1 min-w-0">
                    <h4 class="font-bold text-slate-800 truncate">{{ product.name }}</h4>
                    <p class="text-sm font-black text-primary">R$ {{ "%.2f"|format(product.price) }}</p>
                    {% if product.external_url %}
                    <span class="text-[9px] font-black bg-sky-100 text-sky-600 px-2 py-0.5 rounded-full uppercase">LINK
                        EXTERNO</span>
                    {% endif %}
                </div>
                <div class="text-right flex items-center gap-4">
                    <div class="text-center">
                        <span class="text-[9px] font-black uppercase text-slate-400 block mb-1">Cliques</span>
                        <span class="text-blue-500 font-black text-xl">
                            {{ product.get('clicks_count', 0) }}
                        </span>
                    </div>
                    <div class="text-center">
                        <span class="text-[9px] font-black uppercase text-slate-400 block mb-1">Qtd</span>
                        <span
                            class="{% if product.stock_quantity < 5 %}text-red-500{% else %}text-sky-500{% endif %} font-black text-xl">
                            {{ product.stock_quantity }}
                        </span>
                    </div>
                </div>
            </div>

            <form action="/vendedor/produto/{{ product.id }}/delete" method="POST"
                onsubmit="return confirm('Excluir este produto permanentemente?')"
                class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-all">
                <button type="submit" class="p-2 bg-red-50 text-red-500 rounded-xl hover:bg-red-100">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </button>
            </form>
        </div>
        {% endfor %}
    </div>
</div>

<!-- SEÇÃO DE CONFIGURAÇÕES -->
<div id="section-settings" class="hidden">
    <div class="glass p-8 rounded-3xl max-w-4xl mx-auto border border-primary/10">
        <h3 class="text-2xl font-black text-slate-800 mb-8 border-b border-slate-100 pb-4">Configuração Geral da Loja
        </h3>

        <form action="/vendedor/configuracoes" method="POST" enctype="multipart/form-data" class="space-y-10">
            <!-- Branding -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="space-y-6">
                    <h4 class="text-sm font-black text-slate-400 uppercase tracking-widest">Identidade Visual</h4>
                    <div>
                        <label class="block text-sm font-bold mb-2">Nome da Loja Exibido</label>
                        <input type="text" name="name" value="{{ store.name if store else '' }}"
                            class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:border-primary outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2">WhatsApp de Vendas (Ex: 5511...)</label>
                        <input type="text" name="whatsapp" value="{{ store.whatsapp if store else '' }}"
                            class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:border-primary outline-none">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold mb-2">Cor Primária</label>
                            <input type="color" name="primary_color"
                                value="{{ store.primary_color if store else '#0EA5E9' }}"
                                class="w-full h-12 rounded-xl border border-slate-200 cursor-pointer">
                        </div>
                        <div>
                            <label class="block text-xs font-bold mb-2">Cor Secundária</label>
                            <input type="color" name="secondary_color"
                                value="{{ store.secondary_color if store else '#0284C7' }}"
                                class="w-full h-12 rounded-xl border border-slate-200 cursor-pointer">
                        </div>
                    </div>
                </div>

                <div class="space-y-6 bg-sky-50/20 p-6 rounded-3xl border border-sky-100">
                    <h4 class="text-sm font-black text-sky-600 uppercase tracking-widest">Configurações Financeiras
                        (PIX)</h4>
                    <div>
                        <label class="block text-sm font-bold mb-2">Sua Chave PIX (E-mail, CPF, Tel ou
                            Aleatória)</label>
                        <input type="text" name="pix_key" value="{{ store.pix_key if store else '' }}" required
                            placeholder="chave@pix.com"
                            class="w-full px-4 py-3 rounded-xl border border-sky-200 focus:border-sky-500 outline-none">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-bold mb-2">Nome do Titular</label>
                            <input type="text" name="pix_name" value="{{ store.pix_name if store else '' }}" required
                                placeholder="Ex: João da Silva"
                                class="w-full px-4 py-3 rounded-xl border border-sky-200 focus:border-sky-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-2">Cidade Base</label>
                            <input type="text" name="pix_city" value="{{ store.pix_city if store else '' }}" required
                                placeholder="Ex: São Paulo"
                                class="w-full px-4 py-3 rounded-xl border border-sky-200 focus:border-sky-500 outline-none">
                        </div>
                    </div>
                    <p class="text-[10px] text-sky-600 font-bold italic">Estes dados são usados para gerar o QR Code
                        de pagamento automático para o cliente.</p>
                </div>
            </div>

            <hr class="border-slate-100">

            <!-- Perfil Admin -->
            <div class="space-y-6">
                <h4 class="text-sm font-black text-slate-400 uppercase tracking-widest">Segurança da Conta</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-bold mb-2 text-slate-400">Usuário do Sistema</label>
                        <input type="text" name="admin_user" value="admin" readonly
                            class="w-full px-4 py-3 rounded-xl border border-slate-100 bg-slate-50 text-slate-400 cursor-not-allowed">
                        <span class="text-[9px] text-slate-400 italic">O usuário padrão não pode ser alterado.</span>
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2">Alterar Minha Senha Admin</label>
                        <input type="text" name="admin_password"
                            value="{{ store.admin_password if store else 'admin' }}"
                            class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:border-primary outline-none font-mono">
                    </div>
                </div>
            </div>

            <button type="submit"
                class="w-full py-5 bg-slate-800 text-white rounded-3xl font-black text-xl shadow-xl hover:bg-slate-900 active:scale-95 transition-all">
                ATUALIZAR CONFIGURAÇÕES DA LOJA
            </button>
        </form>
    </div>
</div>

<script>
    function switchTab ( tab )
    {
        document.querySelectorAll( '[id^="section-"]' ).forEach( s => s.classList.add( 'hidden' ) );
        document.querySelectorAll( '[id^="tab-"]' ).forEach( t =>
        {
            t.classList.remove( 'text-primary', 'border-primary' );
            t.classList.add( 'text-slate-400', 'border-transparent' );
        } );

        document.getElementById( `section-${ tab }` ).classList.remove( 'hidden' );
        document.getElementById( `tab-${ tab }` ).classList.add( 'text-primary', 'border-primary' );
        document.getElementById( `tab-${ tab }` ).classList.remove( 'text-slate-400', 'border-transparent' );
    }

    async function importProduct ()
    {
        const url = document.getElementById( 'import_url' ).value;
        if ( !url ) return alert( 'Insira uma URL válida' );

        const btn = event.target;
        btn.innerText = 'BUSCANDO...';
        btn.disabled = true;

        try
        {
            const res = await fetch( `/vendedor/fetch-metadata?url=${ encodeURIComponent( url ) }` );
            const data = await res.json();

            if ( data.error ) throw new Error( data.error );

            document.getElementById( 'p_name' ).value = data.title || '';
            document.getElementById( 'p_desc' ).value = data.description || '';
            document.getElementById( 'p_img' ).value = data.image || '';
            document.getElementById( 'p_ext' ).value = url;
            document.getElementById( 'p_stock' ).value = data.stock || 1;
            document.getElementById( 'p_price' ).value = data.price || '';

            // Popula imagens extras
            if ( data.images && data.images.length > 0 )
            {
                document.getElementById( 'p_extra_images' ).value = JSON.stringify( data.images );

                // Mostrar preview da primeira imagem
                const previewContainer = document.getElementById( 'img_preview_container' );
                const previewImg = document.getElementById( 'img_preview' );
                previewContainer.classList.remove( 'hidden' );
                previewImg.src = data.images[ 0 ];

                // Indicar se imagens foram persistidas
                const statusText = document.querySelector( '#img_preview_container .text-xs' );
                if ( statusText && data.images_persisted )
                {
                    statusText.innerHTML = '✓ <span class="text-green-600 font-bold">Imagem salva no servidor!</span>';
                }

                // Mostrar galeria extra se houver mais de 1 imagem
                if ( data.images.length > 1 )
                {
                    const extraContainer = document.getElementById( 'extra_imgs_preview' );
                    const grid = document.getElementById( 'extra_imgs_grid' );
                    extraContainer.classList.remove( 'hidden' );
                    grid.innerHTML = data.images.slice( 1 ).map( img =>
                        `<img src="${ img }" class="w-12 h-12 object-cover rounded-lg border-2 border-green-400 shadow-sm">`
                    ).join( '' );
                }

                // Esconder upload manual (imagem já importada)
                const fileUpload = document.getElementById( 'file-upload-zone' );
                if ( fileUpload )
                {
                    fileUpload.style.display = 'none';
                }
            }

            let msg = data.images_persisted
                ? `✓ IMPORTAÇÃO COMPLETA! ${ data.images.length } imagem(ns) salvas no servidor.`
                : 'Dados importados (imagens externas).';
            if ( data.price ) msg += ` Preço: R$ ${ data.price }`;
            if ( data.video ) msg += ` Vídeo detectado.`;

            alert( msg + '\n\nClique em PUBLICAR para finalizar.' );
        } catch ( e )
        {
            alert( 'Erro ao importar: ' + e.message );
        } finally
        {
            btn.innerText = 'IMPORTAR';
            btn.disabled = false;
        }
    }

    function updateFileLabel ( input )
    {
        const zone = document.getElementById( 'file-upload-zone' );
        const text = document.getElementById( 'file-upload-text' );
        if ( input.files && input.files[ 0 ] )
        {
            text.textContent = input.files[ 0 ].name;
            zone.classList.add( 'has-file' );
        } else
        {
            text.textContent = 'Clique para enviar imagem';
            zone.classList.remove( 'has-file' );
        }
    }
</script>
{% endblock %}
